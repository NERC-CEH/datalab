---
- name: Prepare all cluster nodes
  hosts: k8s-cluster
  become: yes
  become_method: sudo

  roles:
    - docker
    - kubernetes-common
    - kubernetes
    - kubelet-configuration
    - { role: glusterfs, gluster_server: False }
    - app-armor
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Configure Helm
  hosts: k8s-master

  roles:
    - helm
  environment:
    KUBECONFIG: "/home/{{ deploy_user }}/admin.conf"
    HELM_HOME: "/home/ubuntu/helm"

- name: Base Datalabs kubernetes configuration
  hosts: k8s-master

  roles:
    - role: kubernetes-namespace
      namespace: "{{ test_namespace }}"
    - role: kubernetes-namespace
      namespace: "{{ prod_namespace }}"
    - role: kubernetes-secrets
    - role: vault-secrets
      datalab: "{{ test_namespace }}"
    - role: vault-secrets
      datalab: "{{ prod_namespace }}"

  environment:
    KUBECONFIG: "/home/{{ deploy_user }}/admin.conf"
    HELM_HOME: "/home/ubuntu/helm"
  tags:
    - config
