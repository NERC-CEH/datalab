---
- hosts: insecure

  tasks:
    - name: Change root password
      user: 
        name: root
        password: "{{ root_password }}"

    - name: Add deploy user
      user:
        name: "{{ deploy_user }}"
        password: "{{ deploy_password }}"
        shell: /bin/bash

    - name: Add authorized keys for deploy user
      authorized_key:
        user: "{{ deploy_user }}"
        key: "{{ lookup('file', './keys/{{item}}') }}"
      with_items: "{{ deploy_public_keys }}"

    - name: Add deploy user to sudoers
      lineinfile: dest=/etc/sudoers
                  regexp="{{ deploy_user }} ALL"
                  line="{{ deploy_user }} ALL=(ALL) ALL"
                  state=present

    - name: Update APT package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        state: installed
        pkg: "{{ item }}"
      with_items: "{{ base_packages }}"

    - name: Upgrade APT to the latest packages
      apt:
        upgrade: safe

    - name: Adjust APT update intervals
      copy:
        src: config/apt_periodic
        dest: /etc/apt/apt.conf.d/10periodic

    - name: Setup ufw
      ufw:
        state: enabled
        policy: deny

    - name: Allow ssh traffic
      ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp

    - name: Set up Postfix to relay mail
      debconf: name=postfix
               question='{{ item.question }}'
               value='{{ item.value }}'
               vtype='{{ item.vtype }}'
      with_items:
        - { question: 'postfix/mailname', value: '{{ ansible_fqdn }}', vtype: 'string' }
        - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'string' }

    - name: Email log summary daily
      lineinfile: dest=/etc/cron.daily/00logwatch
                  regexp="^/usr/sbin/logwatch"
                  line="/usr/sbin/logwatch --output mail --mailto {{ logwatch_email }} --detail high"
                  state=present create=yes

    - name: Change ssh port
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^Port\s"
                  line="Port {{ ssh_port }}"
                  state=present
      notify: Restart ssh

    - name: Disallow password authentication
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^PasswordAuthentication"
                  line="PasswordAuthentication no"
                  state=present
      notify: Restart ssh

    - name: Disallow root SSH access
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^PermitRootLogin"
                  line="PermitRootLogin no"
                  state=present
      notify: Restart ssh

  handlers:
    - name: Restart ssh
      service: name=ssh state=restarted