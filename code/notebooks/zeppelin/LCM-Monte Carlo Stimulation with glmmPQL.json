{"paragraphs":[{"text":"%md\nThis SparkR workbook loads the combined dataset and performs a Monte Carlo stimulation using the glmmPQL function. The number of stimulations is defined by the `runCount` variable, this has successfully worked for 1000 runs. The combined data (input) is expected to be in multiple csv files, the path to these files is defined by `inputPath`. The output for each stimulation run is a single CSV giving the predicted values for that model fitting and will be written to the `outputPath` directory. An intermediary file is using to store the reshaped `totrich` data frame and is retrieved during the model fitting step. All the paths must be within the `/data/` directory.","dateUpdated":"2017-08-31T16:07:16+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>This SparkR workbook loads the combined dataset and performs a Monte Carlo stimulation using the glmmPQL function. The number of stimulations is defined by the <code>runCount</code> variable, this has successfully worked for 1000 runs. The combined data (input) is expected to be in multiple csv files, the path to these files is defined by <code>inputPath</code>. The output for each stimulation run is a single CSV giving the predicted values for that model fitting and will be written to the <code>outputPath</code> directory. An intermediary file is using to store the reshaped <code>totrich</code> data frame and is retrieved during the model fitting step. All the paths must be within the <code>/data/</code> directory.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1504195636895_1978886784","id":"20170831-113708_572715440","dateCreated":"2017-08-31T16:07:16+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1740"},{"title":"Define Variables for Monte Carlo Stimulation","text":"%r\nrunCount = 1000\ninputPath = \"/data/lcm/results/lcm_combined/part*\"\noutputPath = \"/data/lcm/results/pql_monte_carlo\"\ntotrichLongTable = \"/data/tmp/totrich.csv\"","user":"datalab","dateUpdated":"2017-08-31T16:20:22+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"\n\n\n\n"}]},"apps":[],"jobName":"paragraph_1504195636905_1961188334","id":"20170829-205956_1552832895","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:20:22+0000","dateFinished":"2017-08-31T16:20:22+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1741"},{"title":"Load Combined Land Cover Map and Survey Dataset","text":"%r\n# magrittr library provides piping via %>%\nlibrary(magrittr)\n\n# Expected processed Land Cover Map data schema\ntotrich.wide.schema <- structType(structField(\"TOTRICH78\", \"integer\"), structField(\"TOTRICH90\", \"integer\"), structField(\"TOTRICH98\", \"integer\"), structField(\"TOTRICH07\", \"integer\"), \n\tstructField(\"PIX_DIST\", \"string\"), structField(\"MODAL_CLASS\", \"integer\"), structField(\"REPEAT_PLO\", \"string\"))\n\n# Read Land Cover Map data to Spark Data Frame - wide table\ntotrich.wide <- read.df(path = inputPath, source = \"csv\", schema = totrich.wide.schema)\n\n# Drop \"REPEAT_PLO\" duplicates\ntotrich.wide.trim <- totrich.wide %>% dropDuplicates(\"REPEAT_PLO\")","user":"datalab","dateUpdated":"2017-08-31T16:10:53+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"\n\n\n\n"}]},"apps":[],"jobName":"paragraph_1504195636909_1959649339","id":"20170829-210205_1806508339","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:10:53+0000","dateFinished":"2017-08-31T16:10:58+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1742"},{"title":"Reshape Data","text":"%r\n# Function to restucture to long table\nreshapeTR <- function(columnYear) {\n\tcolnName <- columnYear[1]\n\tyrValue <- columnYear[2]\n    longTable <- totrich.wide.trim %>% select(colnName, \"PIX_DIST\", \"MODAL_CLASS\", \"REPEAT_PLO\") %>%\n    \twithColumn(\"YR\", lit(yrValue)) %>% withColumnRenamed(colnName, \"TOTRICH\")\n    longTable\n}\n\n# Restucture Land Cover Map data to long table\ncolumnYearLabels <- list(c(\"TOTRICH78\", \"1978\"), c(\"TOTRICH90\", \"1990\"), c(\"TOTRICH98\", \"1998\"), c(\"TOTRICH07\", \"2007\"))\ntotrich.rdd <- do.call(rbind, lapply(columnYearLabels, reshapeTR))","user":"datalab","dateUpdated":"2017-08-31T16:10:55+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"\n\n\n\n"}]},"apps":[],"jobName":"paragraph_1504195636912_1970807057","id":"20170829-210248_795425015","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:10:55+0000","dateFinished":"2017-08-31T16:10:58+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1743"},{"title":"Save Total Richness Data Frame","text":"%r\ntotrich <- collect(totrich.rdd)\nwrite.csv(totrich, file = totrichLongTable, row.names = FALSE)","user":"datalab","dateUpdated":"2017-08-31T16:10:58+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"\n\n\n\n"}]},"apps":[],"jobName":"paragraph_1504195636913_1970422308","id":"20170829-212415_2027937382","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:10:58+0000","dateFinished":"2017-08-31T16:11:16+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1744"},{"title":"Define the Pixel Distribution Sampler Function","text":"%r\n# Function to resample pixel distributions\npixDistSampler <- function(pixDistRaw) {\n    pixDist.counts <- as.double(unlist(strsplit(pixDistRaw, \",\")))\n    pixDist.randCount <- sum(pixDist.counts) * runif(1L)\n    pixDist.csum <- cumsum(pixDist.counts)\n    pixDist.idx <- which(pixDist.csum >= pixDist.randCount)\n    return(as.integer(pixDist.idx[1]))\n}","user":"datalab","dateUpdated":"2017-08-31T16:11:01+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"\n\n\n\n"}]},"apps":[],"jobName":"paragraph_1504195636914_1971576555","id":"20170829-210313_311957393","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:11:01+0000","dateFinished":"2017-08-31T16:11:16+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1745"},{"title":"Define Monte Carlo Stimulation Function","text":"%r\npqlms.func <- function(idx) {\n    start.time <- Sys.time()\n    loadNamespace(\"MASS\")\n    loadNamespace(\"nlme\")\n    totrich <- read.csv(totrichLongTable, stringsAsFactors = FALSE)\n    totrich$MODAL_CLASS <- factor(vapply(totrich$PIX_DIST, pixDistSampler, integer(1L)))\n    totrich$YEAR <- as.integer(totrich$YR)\n    runPredData <- expand.grid(MODAL_CLASS=sort(unique(totrich$MODAL_CLASS)),YR=sort(unique(totrich$YR)))\n    runFit <- MASS::glmmPQL((TOTRICH+1)~MODAL_CLASS*YR, random=~1|REPEAT_PLO, correlation=nlme::corAR1(form=~YEAR|REPEAT_PLO), family=quasipoisson, niter=100, data=totrich)\n    prediction <- predict(runFit, newdata = runPredData, level = 0, type = \"response\")\n    runOutput <- cbind(runPredData, prediction)\n    write.table(runOutput, file = file.path(outputPath, paste0(\"/\", format(round(as.numeric(Sys.time())*1000), digits = 15), \".csv\")), sep=\",\", col.names = FALSE, row.names = FALSE)\n    end.time <- Sys.time()\n    return(end.time - start.time)\n}","user":"datalab","dateUpdated":"2017-08-31T16:11:04+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"\n\n\n\n"}]},"apps":[],"jobName":"paragraph_1504195636915_1971191806","id":"20170829-211512_1386808426","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:11:16+0000","dateFinished":"2017-08-31T16:11:16+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1746"},{"title":"Run the Monte Carlo Stimulation","text":"%r\n# spark.lapply will distribute runs over the Spark cluster\n# out variable contains time taken for each run\nout <- spark.lapply(seq(runCount), pqlms.func)","user":"datalab","dateUpdated":"2017-08-31T16:20:46+0000","config":{"editorSetting":{"language":"r"},"colWidth":12,"editorMode":"ace/mode/r","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1504195636917_1968883312","id":"20170829-214436_1706835124","dateCreated":"2017-08-31T16:07:16+0000","dateStarted":"2017-08-31T16:20:47+0000","dateFinished":"2017-08-31T16:13:02+0000","status":"RUNNING","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:1747"},{"text":"%r\n","user":"datalab","dateUpdated":"2017-08-31T16:11:48+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"r"},"editorMode":"ace/mode/r"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1504195908794_478697748","id":"20170831-161148_573009091","dateCreated":"2017-08-31T16:11:48+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:1748"}],"name":"LCM/Monte Carlo Stimulation with glmmPQL","id":"2CRC6JFH3","angularObjects":{"2CTCRR5U7:shared_process":[],"2CSMATY2Y:shared_process":[],"2CR37SA3F:shared_process":[],"2CU6H55GU:shared_process":[],"2CTMDXN1C:shared_process":[],"2CTB1CT3Y:shared_process":[],"2CUFEA25X:shared_process":[],"2CS6A87QY:shared_process":[],"2CUC34A89:shared_process":[],"2CST4WTTK:shared_process":[],"2CR1NS4T2:shared_process":[],"2CSDUNFFD:shared_process":[],"2CU8GTPDY:shared_process":[],"2CUNY1DDA:shared_process":[],"2CRKNF4HR:shared_process":[],"2CUN85JHW:shared_process":[],"2CTPSPFKF:shared_process":[],"2CRMUDTDY:shared_process":[],"2CT8F88UC:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}