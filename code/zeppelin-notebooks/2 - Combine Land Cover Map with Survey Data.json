{"paragraphs":[{"title":"Introduction","text":"%md\nThis scala workbook loads the land cover map and merges it with the survey data. The land cover map dataset is expected to be in multiple well-known text (wkt) formatted text files and the survey data is expected to be in a csv formatted file. Paths to these files are defined by the variables `lcmFilePath` and `surveyFilePath`. Output from this workbook is written in CSV format to the directory `outputPath`. All the paths must be within the `/data/` directory. (NB: Spark interpreator must have `com.esri.geometry:esri-geometry-api:1.2.1` as an artifact to work)","user":"anonymous","dateUpdated":"2017-07-31T09:25:28+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>This scala workbook loads the land cover map and merges it with the survey data. The land cover map dataset is expected to be in multiple well-known text (wkt) formatted text files and the survey data is expected to be in a csv formatted file. Paths to these files are defined by the variables <code>lcmFilePath</code> and <code>surveyFilePath</code>. Output from this workbook is written in CSV format to the directory <code>outputPath</code>. All the paths must be within the <code>/data/</code> directory. (NB: Spark interpreator must have <code>com.esri.geometry:esri-geometry-api:1.2.1</code> as an artifact to work)</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1501253864945_762155098","id":"20170726-135459_619156081","dateCreated":"2017-07-28T14:57:44+0000","dateStarted":"2017-07-31T09:25:28+0000","dateFinished":"2017-07-31T09:25:28+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:4094"},{"title":"Define paths to for Land Cover Map and Survey Data","text":"val lcmFilePath = \"/data/lcm/csv/lcm25mWKT.*\"\nval surveyFilePath = \"/data/survey/csv/FieldSurvey.csv\"\nval outputPath = \"/data/results/lcm_combined\"","dateUpdated":"2017-07-31T11:22:38+0000","config":{"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1501253864946_763309345","id":"20170726-125342_437515599","dateCreated":"2017-07-28T14:57:44+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4095"},{"title":"Create Case Classes for  Data Import","text":"import com.esri.core.geometry._\nimport org.apache.spark.sql._\n\ncase class SurveyData(id: String, geometry: com.esri.core.geometry.Geometry, totalRichness: Array[Int], repeatPlo: String)\ncase class Feature(geometry: com.esri.core.geometry.Geometry, distribution: Array[Int], modalClass: Int)\ncase class Combined(point: String, polygon: String, distribution: Array[Int], modalClass: Int, totalRichness: Array[Int], repeatPlo: String)","dateUpdated":"2017-07-28T14:57:44+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1501253864947_762924596","id":"20170619-132623_1185164014","dateCreated":"2017-07-28T14:57:44+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4096"},{"title":"Create Data Parsing Functions","text":"def parseFeature(row: Row) : Feature = {\n    val geometryString = row.getAs[String](\"_c0\")\n    val geometry = GeometryEngine.geometryFromWkt(geometryString, WktImportFlags.wktImportDefaults, Geometry.Type.Polygon)\n    val distributionArray = row.getAs[String](\"_c3\").split(\",\").map(_.toInt)\n    val distribution = distributionArray.dropRight(2)\n    val modalClass = distributionArray.takeRight(1)(0)\n\n    Feature(geometry, distribution, modalClass)\n  }\n\ndef parseSurveyRow(row: Row) : SurveyData = {\n    val id = row.getAs[String](\"REP_ID\")\n    val geometryString = row.getAs[String](\"WKT\")\n    val modifiedString = geometryString.split(\" \").dropRight(1).mkString(\" \") + \")\"\n    val geometry = GeometryEngine.geometryFromWkt(modifiedString, WktImportFlags.wktImportDefaults, Geometry.Type.Unknown)\n    val totalRichness = Array[Int](row.getAs[String](\"TOT_RICH78\").toInt, row.getAs[String](\"TOT_RICH90\").toInt,\n                            row.getAs[String](\"TOT_RICH98\").toInt, row.getAs[String](\"TOT_RICH07\").toInt)\n    val repeatPlo = row.getAs[String](\"REPEAT_PLO\")\n    \n    SurveyData(id, geometry, totalRichness, repeatPlo)\n}\n\ndef combine(feature: Feature, surveyData: SurveyData) : Combined = {\n    val point = GeometryEngine.geometryToWkt(surveyData.geometry, WktExportFlags.wktExportPoint)\n    val polygon = GeometryEngine.geometryToWkt(feature.geometry, WktExportFlags.wktExportPolygon)\n    Combined(point, polygon, feature.distribution, feature.modalClass, surveyData.totalRichness, surveyData.repeatPlo)\n}","dateUpdated":"2017-07-28T14:57:44+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1501253864948_761000851","id":"20170619-132708_191963517","dateCreated":"2017-07-28T14:57:44+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4097"},{"title":"Load and Join Land Cover Map with Survey Data","text":"val lcmReader = spark.read.csv(lcmFilePath)\nval lcmData = lcmReader.rdd.map(row => parseFeature(row))\n\nval surveyReader = spark.read.option(\"header\", \"true\").csv(surveyFilePath)\nval surveyData = surveyReader.rdd.map(row => parseSurveyRow(row)).collect()\n\nval bSurveyData = spark.sparkContext.broadcast(surveyData)\n\nval filteredFeatures = lcmData.map(feature => {\n    val pointInFeature: Option[SurveyData] = bSurveyData.value.find(point => {\n        GeometryEngine.contains(feature.geometry, point.geometry, SpatialReference.create(4326))\n    })\n    \n    if (pointInFeature.isDefined) {\n        combine(feature, pointInFeature.get)\n    } else {\n     null\n    }\n}).filter(_ != null)\n\nfilteredFeatures.map(row => {\n    row.totalRichness.mkString(\",\") + \",\" +\n    \"\\\"\" + row.distribution.mkString(\",\") + \"\\\",\" +\n    row.modalClass + \",\" +\n    row.repeatPlo\n}).saveAsTextFile(outputPath)","dateUpdated":"2017-07-28T15:05:02+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/scala","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1501253864948_761000851","id":"20170619-132344_155808096","dateCreated":"2017-07-28T14:57:44+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4098"},{"dateUpdated":"2017-07-28T14:57:44+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1501253864949_760616102","id":"20170619-132454_101307222","dateCreated":"2017-07-28T14:57:44+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4099"}],"name":"2 - Combine Land Cover Map with Survey Data","id":"2CQCRY9DE","angularObjects":{"2CRJXYZ4A:shared_process":[],"2CP3GRG8J:shared_process":[],"2CPERBXDR:shared_process":[],"2CQT4R4HK:shared_process":[],"2CS4TE2YA:shared_process":[],"2CR34MNNR:shared_process":[],"2CPF7YH2C:shared_process":[],"2CN8GHQ4F:shared_process":[],"2CNUGKAPV:shared_process":[],"2CPZ5Q3A3:shared_process":[],"2CRMWD5ZD:shared_process":[],"2CS2QET1R:shared_process":[],"2CN7DPMYX:shared_process":[],"2CQGHBWCK:shared_process":[],"2CPJG2UAF:shared_process":[],"2CRCTT4SH:shared_process":[],"2CQ42UGXN:shared_process":[],"2CPVVYTEH:shared_process":[],"2CRKJD72C:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}